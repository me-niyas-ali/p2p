<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LAN File Sharing (Real Socket.IO)</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }

    h2 {
      text-align: center;
    }

    .container {
      max-width: 600px;
      margin: auto;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    input[type="text"],
    input[type="file"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      width: 100%;
      margin-bottom: 10px;
    }

    button {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    .exit-btn {
      background-color: #ff5722;
    }

    .exit-btn:hover {
      background-color: #e64a19;
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .status-label {
      font-weight: bold;
      margin-top: 10px;
    }

    .status-success {
      color: green;
    }

    .status-failed {
      color: red;
    }

    .progress {
      width: 100%;
      height: 30px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }

    .bar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.3s;
    }

    .cancel-btn {
      background-color: #f44336;
      margin-top: 10px;
    }

    .cancel-btn:hover {
      background-color: #d32f2f;
    }

    .tabs {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      background: #eee;
    }

    .tab-btn.active {
      background: #4caf50;
      color: white;
    }

    #sentFiles,
    #receivedFiles {
      display: none;
    }

    #sentFiles.active,
    #receivedFiles.active {
      display: block;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      opacity: 0.9;
      animation: fadeInOut 4s forwards;
    }

    #statusDisplay {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
    }

    .transfer-info {
      margin-top: 5px;
      font-size: 0.9em;
      color: #555;
    }

    a.download-link {
      display: inline-block;
      margin-top: 10px;
      color: #4caf50;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
    }

    a.download-link:hover {
      text-decoration: underline;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>P2P File Sharing (Socket.IO)</h2>
    <input type="text" id="roomInput" placeholder="Enter Room Code (4-digit)" maxlength="4" />
    <button id="joinBtn">Join Room</button>
    <button id="leaveBtn" class="exit-btn" disabled>Leave Room</button>
    <div id="statusDisplay">Not connected</div>
    <input type="file" id="fileInput" disabled />
    <button id="sendBtn" disabled>Send File</button>
    <div>
      <h3>Sent Files</h3>
      <div id="sentFiles"></div>
    </div>
    <div>
      <h3>Received Files</h3>
      <div id="receivedFiles"></div>
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" integrity="sha384-z5h0HrGQHw1Lk5Po6XLwp2pkThdy7FZgqWE+/aWOPC0tq8nMaZvH6S2JsyZ3KRzM" crossorigin="anonymous"></script>
  <script>
    const socket = io(); // Assumes server is on same origin & port
    let currentRoom = null;
    const chunkSize = 64 * 1024; // 64KB chunks
    let sendingTransfers = {};
    let receivingTransfers = {};

    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const statusDisplay = document.getElementById('statusDisplay');
    const fileInput = document.getElementById('fileInput');
    const sendBtn = document.getElementById('sendBtn');
    const sentFiles = document.getElementById('sentFiles');
    const receivedFiles = document.getElementById('receivedFiles');

    joinBtn.onclick = () => {
      const room = roomInput.value.trim();
      if (!room || room.length !== 4 || !/^\d{4}$/.test(room)) {
        alert('Please enter a valid 4-digit room code.');
        return;
      }
      currentRoom = room;
      socket.emit('joinRoom', room);
      statusDisplay.textContent = `Joined room: ${room}`;
      joinBtn.disabled = true;
      leaveBtn.disabled = false;
      fileInput.disabled = false;
      sendBtn.disabled = false;
      showToast(`Joined room ${room}`, 'green');
    };

    leaveBtn.onclick = () => {
      if (!currentRoom) return;
      socket.emit('leaveRoom', currentRoom);
      currentRoom = null;
      statusDisplay.textContent = 'Not connected';
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      fileInput.disabled = true;
      sendBtn.disabled = true;
      clearTransfers();
      showToast('Left the room', 'orange');
    };

    sendBtn.onclick = () => {
      if (!currentRoom) {
        alert('Join a room first!');
        return;
      }
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a file first.');
        return;
      }
      sendFile(file);
    };

    // Clear UI and cancel any ongoing transfers
    function clearTransfers() {
      // Cancel sending
      for (const id in sendingTransfers) {
        sendingTransfers[id].cancelled = true;
      }
      sendingTransfers = {};

      // Cancel receiving
      for (const id in receivingTransfers) {
        receivingTransfers[id].cancelled = true;
      }
      receivingTransfers = {};

      sentFiles.innerHTML = '';
      receivedFiles.innerHTML = '';
    }

    function formatBytes(bytes) {
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      if (bytes === 0) return '0 Bytes';
      const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
      return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function createProgressCard(container, fileId, fileName, fileSize, isSending) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = (isSending ? 'send-' : 'recv-') + fileId;

      card.innerHTML = `
        <strong>${fileName}</strong><br>
        <small>${formatBytes(fileSize)}</small>
        <div class="progress">
          <div class="bar" style="width:0%;"></div>
        </div>
        <div class="transfer-info">0 / ${formatBytes(fileSize)}</div>
        <button class="cancel-btn">Cancel</button>
        <div class="status-label"></div>
      `;

      container.appendChild(card);
      return card;
    }

    async function sendFile(file) {
      const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      const totalChunks = Math.ceil(file.size / chunkSize);

      const card = createProgressCard(sentFiles, fileId, file.name, file.size, true);
      const bar = card.querySelector('.bar');
      const transferInfo = card.querySelector('.transfer-info');
      const statusLabel = card.querySelector('.status-label');
      const cancelBtn = card.querySelector('.cancel-btn');

      let cancelled = false;
      cancelBtn.onclick = () => {
        cancelled = true;
        if (sendingTransfers[fileId]) sendingTransfers[fileId].cancelled = true;
        socket.emit('file-cancel', { room: currentRoom, fileId });
        bar.style.backgroundColor = '#f44336';
        bar.style.width = '0%';
        transferInfo.textContent = '';
        statusLabel.textContent = 'Transfer canceled';
        statusLabel.className = 'status-label status-failed';
        cancelBtn.disabled = true;
      };

      sendingTransfers[fileId] = { cancelled };

      statusLabel.textContent = 'Sending...';

      for (let i = 0; i < totalChunks; i++) {
        if (cancelled) break;

        const start = i * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);
        const arrayBuffer = await chunk.arrayBuffer();

        // Send chunk as base64 string (simple but not optimal for big files)
        const chunkBase64 = arrayBufferToBase64(arrayBuffer);

        socket.emit('file-chunk', {
          room: currentRoom,
          fileId,
          chunk: chunkBase64,
          chunkIndex: i,
          totalChunks,
          fileName: file.name,
          fileSize: file.size,
        });

        // Update UI progress
        const progressPercent = ((i + 1) / totalChunks) * 100;
        bar.style.width = progressPercent + '%';
        transferInfo.textContent = `${formatBytes((i + 1) * chunkSize)} / ${formatBytes(file.size)}`;
      }

      if (!cancelled) {
        statusLabel.textContent = 'File sent';
        statusLabel.className = 'status-label status-success';
        cancelBtn.disabled = true;
        showToast('File sent successfully', 'green');
      }

      delete sendingTransfers[fileId];
    }

    // Helper to convert ArrayBuffer to base64
    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }

    // Helper to convert base64 to ArrayBuffer
    function base64ToArrayBuffer(base64) {
      const binary = window.atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    socket.on('file-chunk', ({ fileId, chunk, chunkIndex, totalChunks, fileName, fileSize }) => {
      if (!receivingTransfers[fileId]) {
        // Create new receive card
        const card = createProgressCard(receivedFiles, fileId, fileName, fileSize, false);
        const cancelBtn = card.querySelector('.cancel-btn');
        const bar = card.querySelector('.bar');
        const transferInfo = card.querySelector('.transfer-info');
        const statusLabel = card.querySelector('.status-label');

        receivingTransfers[fileId] = {
          chunks: [],
          receivedCount: 0,
          totalChunks,
          fileSize,
          fileName,
          cancelled: false,
          card,
          bar,
          transferInfo,
          statusLabel,
          cancelBtn,
        };

        cancelBtn.onclick = () => {
          receivingTransfers[fileId].cancelled = true;
          socket.emit('file-cancel', { room: currentRoom, fileId });
          bar.style.backgroundColor = '#f44336';
          bar.style.width = '0%';
          transferInfo.textContent = '';
          statusLabel.textContent = 'Transfer canceled';
          statusLabel.className = 'status-label status-failed';
          cancelBtn.disabled = true;
        };

        statusLabel.textContent = 'Receiving...';
      }

      const transfer = receivingTransfers[fileId];
      if (transfer.cancelled) return;

      // Store chunk in the correct index
      transfer.chunks[chunkIndex] = base64ToArrayBuffer(chunk);
      transfer.receivedCount++;

      // Update UI progress
      const percent = (transfer.receivedCount / totalChunks) * 100;
      transfer.bar.style.width = percent + '%';
      const receivedBytes = Math.min(transfer.receivedCount * chunkSize, fileSize);
      transfer.transferInfo.textContent = `${formatBytes(receivedBytes)} / ${formatBytes(fileSize)}`;

      // If all chunks received, assemble file and show download link
      if (transfer.receivedCount === totalChunks) {
        transfer.statusLabel.textContent = 'File received';
        transfer.statusLabel.className = 'status-label status-success';
        transfer.cancelBtn.disabled = true;

        const blob = new Blob(transfer.chunks);
        const url = URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = url;
        link.download = transfer.fileName;
        link.textContent = 'Download';
        link.className = 'download-link';

        transfer.card.appendChild(link);
        showToast('File received successfully', 'green');

        delete receivingTransfers[fileId];
      }
    });

    socket.on('file-cancel', ({ fileId }) => {
      // Cancel receive transfer UI if exists
      const transfer = receivingTransfers[fileId];
      if (transfer) {
        transfer.cancelled = true;
        transfer.bar.style.backgroundColor = '#f44336';
        transfer.bar.style.width = '0%';
        transfer.transferInfo.textContent = '';
        transfer.statusLabel.textContent = 'Transfer canceled';
        transfer.statusLabel.className = 'status-label status-failed';
        transfer.cancelBtn.disabled = true;
        delete receivingTransfers[fileId];
      }

      // Cancel send transfer UI if exists
      const sendTransfer = sendingTransfers[fileId];
      if (sendTransfer) {
        sendTransfer.cancelled = true;
        const card = document.getElementById('send-' + fileId);
        if (card) {
          const bar = card.querySelector('.bar');
          const transferInfo = card.querySelector('.transfer-info');
          const statusLabel = card.querySelector('.status-label');
          const cancelBtn = card.querySelector('.cancel-btn');
          bar.style.backgroundColor = '#f44336';
          bar.style.width = '0%';
          transferInfo.textContent = '';
          statusLabel.textContent = 'Transfer canceled';
          statusLabel.className = 'status-label status-failed';
          cancelBtn.disabled = true;
        }
        delete sendingTransfers[fileId];
      }
    });

    socket.on('deviceCount', (count) => {
      statusDisplay.textContent = `Devices in room: ${count}`;
    });

    // Toast function
    function showToast(message, color) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.position = 'fixed';
      toast.style.bottom = '20px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.backgroundColor = color;
      toast.style.color = '#fff';
      toast.style.padding = '10px 20px';
      toast.style.borderRadius = '5px';
      toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      toast.style.zIndex = 9999;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>

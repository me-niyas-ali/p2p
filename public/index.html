<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LAN File Sharing</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #status { margin-bottom: 10px; }
  #receivedFiles, #sentFiles { margin-top: 20px; }
  .progress-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; }
  .bar {
    width: 0;
    height: 12px;
    background: #2196F3;
    margin-top: 6px;
    transition: width 0.3s ease;
  }
  .status-label { margin-top: 6px; font-weight: bold; }
  .status-success { color: green; }
  .status-failed { color: red; }
  .cancel-btn {
    margin-top: 6px;
    padding: 4px 8px;
    background: #f44336;
    color: white;
    border: none;
    cursor: pointer;
  }
  .download-link {
    display: inline-block;
    margin-top: 8px;
    color: green;
    text-decoration: none;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>LAN File Sharing</h1>

<label>Room Code (4-digit): <input type="text" id="roomInput" maxlength="4" pattern="\d{4}" /></label>
<button id="joinBtn">Join Room</button>

<div id="status">Devices in room: 0</div>

<input type="file" id="fileInput" multiple disabled />
<button id="sendBtn" disabled>Send</button>

<h2>Sending Files</h2>
<div id="sentFiles"></div>

<h2>Received Files</h2>
<div id="receivedFiles"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const roomInput = document.getElementById('roomInput');
  const joinBtn = document.getElementById('joinBtn');
  const statusDisplay = document.getElementById('status');

  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');

  const sentFiles = document.getElementById('sentFiles');
  const receivedFiles = document.getElementById('receivedFiles');

  let currentRoom = null;

  const chunkSize = 64 * 1024; // 64KB chunks

  // Track ongoing transfers to support cancel
  const sendingTransfers = {};
  const receivingTransfers = {};

  joinBtn.onclick = () => {
    const room = roomInput.value.trim();
    if (!/^\d{4}$/.test(room)) {
      alert('Enter a valid 4-digit room code');
      return;
    }
    currentRoom = room;
    socket.emit('join-room', room);
    statusDisplay.textContent = `Joined room ${room}. Devices in room: 1`;
    fileInput.disabled = false;
    sendBtn.disabled = false;
    joinBtn.disabled = true;
    roomInput.disabled = true;
  };

  socket.on('deviceCount', (count) => {
    statusDisplay.textContent = `Devices in room: ${count}`;
  });

  sendBtn.onclick = () => {
    const files = fileInput.files;
    if (!files.length) {
      alert('Select files to send');
      return;
    }
    for (const file of files) {
      sendFile(file);
    }
  };

function sendFile(file) {
  const fileId = Date.now() + '-' + Math.random().toString(36).slice(2);
  const totalChunks = Math.ceil(file.size / chunkSize);

  const card = document.createElement('div');
  card.className = 'progress-card';
  card.id = 'send-' + fileId;
  card.innerHTML = `
    <div><strong>Sending:</strong> ${file.name} (${formatBytes(file.size)})</div>
    <div class="bar"></div>
    <div class="transfer-info"></div>
    <div class="status-label">Waiting...</div>
    <button class="cancel-btn">Cancel</button>
  `;
  sentFiles.appendChild(card);

  const bar = card.querySelector('.bar');
  const transferInfo = card.querySelector('.transfer-info');
  const statusLabel = card.querySelector('.status-label');
  const cancelBtn = card.querySelector('.cancel-btn');

  const transferObj = { cancelled: false };
  sendingTransfers[fileId] = transferObj;

  cancelBtn.onclick = () => {
    transferObj.cancelled = true;
    socket.emit('file-cancel', { room: currentRoom, fileId });
    bar.style.backgroundColor = '#f44336';
    bar.style.width = '0%';
    transferInfo.textContent = '';
    statusLabel.textContent = 'Transfer canceled';
    statusLabel.className = 'status-label status-failed';
    cancelBtn.disabled = true;
  };

  statusLabel.textContent = 'Sending...';

  (async () => {
    for (let i = 0; i < totalChunks; i++) {
      if (transferObj.cancelled) break;

      const start = i * chunkSize;
      const end = Math.min(file.size, start + chunkSize);
      const chunk = file.slice(start, end);
      const arrayBuffer = await chunk.arrayBuffer();
      const chunkBase64 = arrayBufferToBase64(arrayBuffer);

      socket.emit('file-chunk', {
        room: currentRoom,
        fileId,
        chunk: chunkBase64,
        chunkIndex: i,
        totalChunks,
        fileName: file.name,
        fileSize: file.size,
      });

      const progressPercent = ((i + 1) / totalChunks) * 100;
      bar.style.width = progressPercent + '%';
      transferInfo.textContent = `${formatBytes((i + 1) * chunkSize)} / ${formatBytes(file.size)}`;
    }

    if (!transferObj.cancelled) {
      statusLabel.textContent = 'File sent';
      statusLabel.className = 'status-label status-success';
      cancelBtn.disabled = true;
    }

    delete sendingTransfers[fileId];
  })();
}


  socket.on('file-chunk', ({ fileId, chunk, chunkIndex, totalChunks, fileName, fileSize }) => {
    if (!receivingTransfers[fileId]) {
      // Create UI card
      const card = document.createElement('div');
      card.className = 'progress-card';
      card.id = 'recv-' + fileId;
      card.innerHTML = `
        <div><strong>Receiving:</strong> ${fileName} (${formatBytes(fileSize)})</div>
        <div class="bar"></div>
        <div class="transfer-info"></div>
        <div class="status-label">Receiving...</div>
        <button class="cancel-btn">Cancel</button>
      `;
      receivedFiles.appendChild(card);

      const cancelBtn = card.querySelector('.cancel-btn');
      const bar = card.querySelector('.bar');
      const transferInfo = card.querySelector('.transfer-info');
      const statusLabel = card.querySelector('.status-label');

      receivingTransfers[fileId] = {
        chunks: [],
        receivedCount: 0,
        totalChunks,
        fileSize,
        fileName,
        cancelled: false,
        card,
        bar,
        transferInfo,
        statusLabel,
        cancelBtn,
      };

      cancelBtn.onclick = () => {
        const t = receivingTransfers[fileId];
        t.cancelled = true;
        socket.emit('file-cancel', { room: currentRoom, fileId });
        bar.style.backgroundColor = '#f44336';
        bar.style.width = '0%';
        transferInfo.textContent = '';
        statusLabel.textContent = 'Transfer canceled';
        statusLabel.className = 'status-label status-failed';
        cancelBtn.disabled = true;
      };
    }

    const t = receivingTransfers[fileId];
    if (t.cancelled) return;

    // Store chunk
    t.chunks[chunkIndex] = base64ToArrayBuffer(chunk);
    t.receivedCount++;

    // Update progress
    const percent = (t.receivedCount / totalChunks) * 100;
    t.bar.style.width = percent + '%';
    const receivedBytes = Math.min(t.receivedCount * chunkSize, fileSize);
    t.transferInfo.textContent = `${formatBytes(receivedBytes)} / ${formatBytes(fileSize)}`;

    // Complete
    if (t.receivedCount === totalChunks) {
      t.statusLabel.textContent = 'File received';
      t.statusLabel.className = 'status-label status-success';
      t.cancelBtn.disabled = true;

      const blob = new Blob(t.chunks);
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = t.fileName;
      link.textContent = 'Download';
      link.className = 'download-link';

      t.card.appendChild(link);

      delete receivingTransfers[fileId];
    }
  });

  socket.on('file-cancel', ({ fileId }) => {
    // Cancel receive UI
    const t = receivingTransfers[fileId];
    if (t) {
      t.cancelled = true;
      t.bar.style.backgroundColor = '#f44336';
      t.bar.style.width = '0%';
      t.transferInfo.textContent = '';
      t.statusLabel.textContent = 'Transfer canceled';
      t.statusLabel.className = 'status-label status-failed';
      t.cancelBtn.disabled = true;
      delete receivingTransfers[fileId];
    }

    // Cancel send UI
    const s = sendingTransfers[fileId];
    if (s) {
      s.cancelled = true;
      const card = document.getElementById('send-' + fileId);
      if (card) {
        const bar = card.querySelector('.bar');
        const transferInfo = card.querySelector('.transfer-info');
        const statusLabel = card.querySelector('.status-label');
        const cancelBtn = card.querySelector('.cancel-btn');

        bar.style.backgroundColor = '#f44336';
        bar.style.width = '0%';
        transferInfo.textContent = '';
        statusLabel.textContent = 'Transfer canceled';
        statusLabel.className = 'status-label status-failed';
        cancelBtn.disabled = true;
      }
      delete sendingTransfers[fileId];
    }
  });

  // Helpers
  function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
  }

  function base64ToArrayBuffer(base64) {
    const binary = window.atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
  }

  function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LAN File Sharing</title>
<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
  }

  h2, h3 {
    text-align: center;
  }

  .container {
    max-width: 500px;
    margin: auto;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  input[type="text"],
  input[type="file"] {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  button {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 5px;
    color: white;
    border: none;
    cursor: pointer;
  }

  .card {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background: #fff;
  }

  .progress {
    width: 100%;
    height: 15px;
    background: #eee;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
  }

  .bar {
    height: 100%;
    width: 0;
    background: #4caf50;
    transition: width 0.3s;
  }

  #sendBtn {
    background-color: #4caf50;
  }

  #cancelSendBtn {
    background-color: #f44336;
    display: none;
  }

  #cancelReceiveBtn {
    background-color: #f44336;
    display: none;
  }

  #downloadBtn {
    background-color: #2196f3;
    display: none;
  }

  .bg-success {
    background-color: #4caf50;
  }

  .bg-error {
    background-color: #f44336;
  }

  .bg-info {
    background-color: #2196f3;
  }

  .success, .error {
    display: none;
    margin-top: 10px;
  }

  .success {
    color: #4caf50;
  }

  .error {
    color: #f44336;
  }
</style>
</head>
<body>
  <div class="container">
    <h2>P2P File Sharing</h2>
    <div>Room ID: <span id="roomId">----</span></div>
    <div>Connected Devices: <span id="connectedDevice">0</span></div>
    <input type="text" id="roomIdinput" placeholder="Enter Room Code (4-digit) to Host / Join" maxlength="4" />
    <button id="joinBtn" class="bg-info">Join Room</button>
    <input type="file" id="fileInput" />
    <button id="sendBtn">Send</button>
    <button id="cancelSendBtn">Cancel Sending</button>

    <div id="sendFilesDisplay">
      <h3>Send Files</h3>
      <div class="card">
        <p><strong id="sendFileName">-</strong></p>
        <p id="sendFileSize">0 / 0</p>
        <div class="progress"><div class="bar" id="sendProgressbar"></div></div>
        <p class="success" id="sendSuccessMsg">File Sent</p>
        <p class="error" id="sendErrorMsg">Transfer Error</p>
        <p class="error" id="sendCancelMsg">Transfer Cancelled</p>
      </div>
    </div>

    <div id="receivedFilesDisplay">
      <h3>Received Files</h3>
      <div class="card">
        <p><strong id="receiveFileName">-</strong></p>
        <p id="receiveFileSize">0 / 0</p>
        <div class="progress"><div class="bar" id="receiveProgressbar"></div></div>
        <button id="cancelReceiveBtn">Cancel Receiving</button>
        <p class="success" id="receiveSuccessMsg">File Received</p>
        <p class="error" id="receiveErrorMsg">Transfer Error</p>
        <p class="error" id="receiveCancelMsg">Transfer Cancelled</p>
        <button id="downloadBtn">Download</button>
      </div>
    </div>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const roomIdInput = document.getElementById('roomIdinput');
  const roomIdDisplay = document.getElementById('roomId');
  const connectedDeviceDisplay = document.getElementById('connectedDevice');
  const joinBtn = document.getElementById('joinBtn');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const cancelSendBtn = document.getElementById('cancelSendBtn');
  const cancelReceiveBtn = document.getElementById('cancelReceiveBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  // Send area elements
  const sendFileName = document.getElementById('sendFileName');
  const sendFileSize = document.getElementById('sendFileSize');
  const sendProgressbar = document.getElementById('sendProgressbar');
  const sendSuccessMsg = document.getElementById('sendSuccessMsg');
  const sendErrorMsg = document.getElementById('sendErrorMsg');
  const sendCancelMsg = document.getElementById('sendCancelMsg');

  // Receive area elements
  const receiveFileName = document.getElementById('receiveFileName');
  const receiveFileSize = document.getElementById('receiveFileSize');
  const receiveProgressbar = document.getElementById('receiveProgressbar');
  const receiveSuccessMsg = document.getElementById('receiveSuccessMsg');
  const receiveErrorMsg = document.getElementById('receiveErrorMsg');
  const receiveCancelMsg = document.getElementById('receiveCancelMsg');

  let joined = false;
  let roomId = null;
  let isHost = false;

  let sendFile = null;
  let sendFileReader = null;
  let sendOffset = 0;
  const CHUNK_SIZE = 64 * 1024; // 64KB

  let receiveFileMetadata = null;
  let receiveBuffer = [];
  let receiveReceivedSize = 0;

  function resetSendUI() {
    sendFileName.textContent = '-';
    sendFileSize.textContent = '0 / 0';
    sendProgressbar.style.width = '0%';
    sendSuccessMsg.style.display = 'none';
    sendErrorMsg.style.display = 'none';
    sendCancelMsg.style.display = 'none';
    cancelSendBtn.style.display = 'none';
  }

  function resetReceiveUI() {
    receiveFileName.textContent = '-';
    receiveFileSize.textContent = '0 / 0';
    receiveProgressbar.style.width = '0%';
    receiveSuccessMsg.style.display = 'none';
    receiveErrorMsg.style.display = 'none';
    receiveCancelMsg.style.display = 'none';
    cancelReceiveBtn.style.display = 'none';
    downloadBtn.style.display = 'none';
  }

  function updateConnectedDevices(count) {
    connectedDeviceDisplay.textContent = count;
  }

  function updateRoomId(id) {
    roomIdDisplay.textContent = id || '----';
  }

  function sendChunk() {
    if (!sendFile || !sendFileReader) return;

    if (sendOffset >= sendFile.size) {
      socket.emit('send-file-complete', roomId);
      sendSuccessMsg.style.display = 'block';
      cancelSendBtn.style.display = 'none';
      return;
    }

    const slice = sendFile.slice(sendOffset, sendOffset + CHUNK_SIZE);
    sendFileReader.readAsArrayBuffer(slice);
  }

  joinBtn.addEventListener('click', () => {
    if (joined) {
      // Leave room
      socket.emit('leave-room', roomId);
      joined = false;
      joinBtn.textContent = 'Join Room';
      updateRoomId(null);
      updateConnectedDevices(0);
      isHost = false;
      resetSendUI();
      resetReceiveUI();
      fileInput.disabled = true;
      sendBtn.disabled = true;
      cancelSendBtn.style.display = 'none';
      cancelReceiveBtn.style.display = 'none';
      downloadBtn.style.display = 'none';
      roomId = null;
    } else {
      // Join room
      const inputId = roomIdInput.value.trim();
      if (!/^\d{4}$/.test(inputId)) {
        alert('Please enter a valid 4-digit room code');
        return;
      }
      roomId = inputId;
      socket.emit('join-room', roomId);
      joined = true;
      joinBtn.textContent = 'Leave Room';
      updateRoomId(roomId);
      fileInput.disabled = false;
      sendBtn.disabled = false;
    }
  });

  socket.on('connected-count', (count) => {
    updateConnectedDevices(count);
  });

  socket.on('host-status', (status) => {
    // status can be boolean or socket id string
    isHost = (typeof status === 'boolean') ? status : (status === socket.id);
    if (isHost) {
      console.log('You are host.');
    } else {
      console.log('You are guest.');
    }
  });

  sendBtn.addEventListener('click', () => {
    if (!fileInput.files.length) {
      alert('Please select a file first');
      return;
    }
    if (!joined) {
      alert('Please join a room first');
      return;
    }

    sendFile = fileInput.files[0];
    sendOffset = 0;

    resetSendUI();
    sendFileName.textContent = sendFile.name;
    sendFileSize.textContent = `0 / ${sendFile.size} bytes`;
    cancelSendBtn.style.display = 'inline-block';

    // Send file metadata first
    const metadata = {
      name: sendFile.name,
      size: sendFile.size,
      type: sendFile.type
    };
    socket.emit('send-file-meta', { roomId, metadata });

    sendFileReader = new FileReader();
    sendFileReader.onload = (e) => {
      // Send chunk as ArrayBuffer (converted to Buffer on server)
      socket.emit('send-file-chunk', { roomId, chunk: e.target.result });
      sendOffset += CHUNK_SIZE;

      sendFileSize.textContent = `${Math.min(sendOffset, sendFile.size)} / ${sendFile.size} bytes`;
      const percent = Math.floor((sendOffset / sendFile.size) * 100);
      sendProgressbar.style.width = percent + '%';

      if (sendOffset < sendFile.size) {
        sendChunk();
      } else {
        // Complete event will be emitted in sendChunk()
      }
    };

    sendChunk();
  });

  cancelSendBtn.addEventListener('click', () => {
    if (!joined) return;
    socket.emit('send-cancel-transfer', roomId);
    resetSendUI();
  });

  cancelReceiveBtn.addEventListener('click', () => {
    receiveBuffer = [];
    receiveFileMetadata = null;
    receiveReceivedSize = 0;
    socket.emit('send-cancel-transfer', roomId);
    resetReceiveUI();
  });

  // Receiving metadata
  socket.on('file-meta', (metadata) => {
    resetReceiveUI();
    receiveFileMetadata = metadata;
    receiveReceivedSize = 0;
    receiveBuffer = [];

    receiveFileName.textContent = metadata.name;
    receiveFileSize.textContent = `0 / ${metadata.size} bytes`;
    cancelReceiveBtn.style.display = 'inline-block';
  });

  // Receiving chunk
  socket.on('file-chunk', (chunk) => {
    if (!receiveFileMetadata) return;

    receiveBuffer.push(chunk);
    receiveReceivedSize += chunk.byteLength || chunk.length || 0;

    receiveFileSize.textContent = `${receiveReceivedSize} / ${receiveFileMetadata.size} bytes`;
    const percent = Math.floor((receiveReceivedSize / receiveFileMetadata.size) * 100);
    receiveProgressbar.style.width = percent + '%';

    if (receiveReceivedSize >= receiveFileMetadata.size) {
      socket.emit('send-file-complete', roomId); // confirm complete to sender if needed

      receiveSuccessMsg.style.display = 'block';
      cancelReceiveBtn.style.display = 'none';
      downloadBtn.style.display = 'inline-block';
    }
  });

  socket.on('file-complete', () => {
    // File transfer complete
  });

  socket.on('cancel-transfer', () => {
    resetSendUI();
    resetReceiveUI();
  });

  downloadBtn.addEventListener('click', () => {
    if (!receiveBuffer.length || !receiveFileMetadata) return;

    const blob = new Blob(receiveBuffer, { type: receiveFileMetadata.type || 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = receiveFileMetadata.name;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 100);
  });

  // Disable inputs initially
  fileInput.disabled = true;
  sendBtn.disabled = true;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LAN File Sharing</title>
    <style>
   * {
    box-sizing: border-box;
   }

   body {
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
   }

   h2,
   h3 {
    text-align: center;
   }

   .container {
    max-width: 500px;
    margin: auto;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
   }

   input[type="text"],
   input[type="file"] {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
   }

   #roomDisplay,
   #connectedDisplay {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
   }

   button {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 5px;
    color: white;
    border: none;
    cursor: pointer;
   }

   .card {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background: #fff;
   }

   .progress {
    width: 100%;
    height: 15px;
    background: #eee;
    border-radius: 5px;
    overflow: hidden;
    margin-top: 10px;
   }

   .bar {
    height: 100%;
    width: 10%;
    background: #4caf50;
    transition: width 0.3s;
   }

   #sendBtn {
    display: block;
    margin-top: 10px;
    word-break: break-word;
    background-color: #4caf50;
   }

   #cancelBtn {
    display: block;
    margin-top: 10px;
    word-break: break-word;
    background-color: #f44336;
   }

   #downloadBtn {
    display: block;
    margin-top: 10px;
    word-break: break-word;
    background-color: #2196f3;
   }

   .bg-success {
    background-color: #4caf50;
   }

   .bg-error {
    background-color: #f44336;
   }

   .bg-info {
    background-color: #2196f3;
   }

   .success {
    color: #4caf50;
   }

   .error {
    color: #f44336;
   }

   .info {
    color: #2196f3;
   }
  </style>
</head>
<body>
  <div class="container">
    <h2>P2P File Sharing</h2>
    <input type="file" id="fileInput" />
    <div>Room ID : <span id="roomId">----</span></div>
    <div>Connected Devices : <span id="connectedDevice">0</span></div>
    <input type="text" id="roomIdinput" placeholder="Enter Room Code (4-digit) to join" maxlength="4" />
    <button id="joinBtn" class="bg-info">Join Room</button>
    <button id="sendBtn" class="bg-success">Send</button>

    <div id="sendFilesDisplay">
      <h3>Send Files</h3>
      <div class="card" id="sendCard" style="display: none;">
        <p><strong id="sendFileName">file.name</strong></p>
        <p id="sendFileSize">0 / 0</p>
        <div class="progress"><div class="bar" id="sendProgressbar"></div></div>
        <button id="cancelSendBtn" class="bg-error">Cancel</button>
        <p class="success" id="sendSuccess" style="display:none;">File Sent</p>
        <p class="error" id="sendError" style="display:none;">Transfer Error</p>
        <p class="error" id="sendCancel" style="display:none;">Transfer Cancelled</p>
      </div>
    </div>

    <div id="receivedFilesDisplay">
      <h3>Received Files</h3>
      <div class="card" id="receiveCard" style="display: none;">
        <p><strong id="receiveFileName">file.name</strong></p>
        <p id="receiveFileSize">0 / 0</p>
        <div class="progress"><div class="bar" id="receiveProgressbar"></div></div>
        <button id="cancelReceiveBtn" class="bg-error">Cancel</button>
        <p class="success" id="receiveSuccess" style="display:none;">File Received</p>
        <p class="error" id="receiveError" style="display:none;">Transfer Error</p>
        <p class="error" id="receiveCancel" style="display:none;">Transfer Cancelled</p>
        <button id="downloadBtn" style="display:none;">Download</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io(); // Connect to your Socket.IO server
    const fileInput = document.getElementById('fileInput');
    const roomIdDisplay = document.getElementById('roomId');
    const connectedDevice = document.getElementById('connectedDevice');
    const roomInput = document.getElementById('roomIdinput');
    const joinBtn = document.getElementById('joinBtn');
    const sendBtn = document.getElementById('sendBtn');

    let roomId = null;
    let isHost = false;
    let peerConnection;
    let dataChannel;
    let fileToSend;
    let receivedBuffer = [];
    let receivedSize = 0;
    let totalSize = 0;

    // Generate room ID when file is selected
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length === 0) return;
      fileToSend = fileInput.files[0];
      roomId = Math.floor(1000 + Math.random() * 9000).toString();
      roomIdDisplay.textContent = roomId;
      socket.emit('create-room', roomId);
      isHost = true;
    });

    joinBtn.addEventListener('click', () => {
      if (joinBtn.textContent === "Join Room") {
        const inputRoom = roomInput.value;
        if (inputRoom.length !== 4) return alert("Enter valid 4-digit room ID");
        roomId = inputRoom;
        socket.emit('join-room', roomId);
        joinBtn.textContent = "Exit Room";
        joinBtn.classList.remove("bg-info");
        joinBtn.classList.add("bg-error");
      } else {
        socket.emit('leave-room', roomId);
        joinBtn.textContent = "Join Room";
        joinBtn.classList.remove("bg-error");
        joinBtn.classList.add("bg-info");
        roomId = null;
      }
    });

    sendBtn.addEventListener('click', () => {
      if (!fileToSend || !dataChannel) return;
      const chunkSize = 16 * 1024;
      const reader = new FileReader();
      let offset = 0;

      document.getElementById("sendCard").style.display = "block";

      reader.addEventListener('error', err => {
        console.error('Error reading file:', err);
      });

      reader.addEventListener('load', e => {
        dataChannel.send(e.target.result);
        offset += e.target.result.byteLength;
        updateProgress("sendProgressbar", offset, fileToSend.size);
        document.getElementById("sendFileSize").textContent = `${offset} / ${fileToSend.size}`;

        if (offset < fileToSend.size) {
          readSlice(offset);
        } else {
          document.getElementById("sendSuccess").style.display = "block";
        }
      });

      const readSlice = o => {
        const slice = fileToSend.slice(o, o + chunkSize);
        reader.readAsArrayBuffer(slice);
      };

      readSlice(0);
    });

    // WebRTC Setup
    function createPeer() {
      peerConnection = new RTCPeerConnection();
      dataChannel = peerConnection.createDataChannel("fileTransfer");

      dataChannel.onopen = () => console.log("Data channel open");
      dataChannel.onmessage = receiveChunk;

      peerConnection.onicecandidate = ({ candidate }) => {
        if (candidate) socket.emit('ice-candidate', roomId, candidate);
      };

      peerConnection.createOffer().then(offer => {
        peerConnection.setLocalDescription(offer);
        socket.emit('offer', roomId, offer);
      });
    }

    function handleOffer(offer) {
      peerConnection = new RTCPeerConnection();
      peerConnection.ondatachannel = e => {
        dataChannel = e.channel;
        dataChannel.onmessage = receiveChunk;
      };
      peerConnection.onicecandidate = ({ candidate }) => {
        if (candidate) socket.emit('ice-candidate', roomId, candidate);
      };
      peerConnection.setRemoteDescription(offer).then(() =>
        peerConnection.createAnswer().then(answer => {
          peerConnection.setLocalDescription(answer);
          socket.emit('answer', roomId, answer);
        })
      );
    }

    function receiveChunk(event) {
      if (!totalSize) totalSize = fileToSend?.size || 0;
      receivedBuffer.push(event.data);
      receivedSize += event.data.byteLength;
      updateProgress("receiveProgressbar", receivedSize, totalSize);
      document.getElementById("receiveFileSize").textContent = `${receivedSize} / ${totalSize}`;
      document.getElementById("receiveCard").style.display = "block";

      if (receivedSize === totalSize) {
        const receivedBlob = new Blob(receivedBuffer);
        const a = document.getElementById("downloadBtn");
        a.href = URL.createObjectURL(receivedBlob);
        a.download = "received_file";
        a.style.display = "block";
        document.getElementById("receiveSuccess").style.display = "block";
      }
    }

    function updateProgress(barId, value, max) {
      const bar = document.getElementById(barId);
      const percent = Math.floor((value / max) * 100);
      bar.style.width = percent + "%";
    }

    // Socket Events
    socket.on('room-joined', () => {
      createPeer();
      connectedDevice.textContent = 1;
    });

    socket.on('offer', offer => handleOffer(offer));
    socket.on('answer', answer => peerConnection.setRemoteDescription(answer));
    socket.on('ice-candidate', candidate => peerConnection.addIceCandidate(candidate));
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P File Share</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f4f4f4;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
    }

    h2 {
      text-align: center;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
    }

    .status {
      text-align: center;
      margin: 10px 0;
    }

    .file-info, .progress-card {
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    progress {
      width: 100%;
    }

    .hidden {
      display: none;
    }

    .notification {
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .notification.success { background: #d4edda; color: #155724; }
    .notification.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h2>P2P File Share</h2>

    <input type="text" id="roomId" placeholder="Enter 4-digit Room ID" maxlength="4"/>
    <button id="toggleRoom">Join Room</button>

    <div class="status">
      Room: <span id="statusRoom">-</span><br/>
      Devices Connected: <span id="deviceCount">0</span>
    </div>

    <input type="file" id="fileInput"/>
    <div class="file-info hidden" id="fileInfo"></div>
    <button id="sendBtn" class="hidden">Send File</button>

    <div class="progress-card hidden" id="progressCard">
      <div id="transferLabel">Transferring...</div>
      <progress id="progressBar" value="0" max="100"></progress>
      <div id="progressDetails">0 KB / 0 KB</div>
      <button id="cancelBtn">Cancel</button>
    </div>

    <button id="downloadBtn" class="hidden">Download File</button>

    <div id="notificationArea"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomIdInput = document.getElementById('roomId');
    const toggleRoomBtn = document.getElementById('toggleRoom');
    const statusRoom = document.getElementById('statusRoom');
    const deviceCount = document.getElementById('deviceCount');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const sendBtn = document.getElementById('sendBtn');
    const progressCard = document.getElementById('progressCard');
    const progressBar = document.getElementById('progressBar');
    const progressDetails = document.getElementById('progressDetails');
    const cancelBtn = document.getElementById('cancelBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const notificationArea = document.getElementById('notificationArea');
    const transferLabel = document.getElementById('transferLabel');

    let connected = false;
    let selectedFile;
    let roomId;
    let host = false;
    let peerConnections = {};
    let currentTransfer;

    function notify(msg, type = 'success') {
      const div = document.createElement('div');
      div.className = `notification ${type}`;
      div.textContent = msg;
      notificationArea.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    toggleRoomBtn.onclick = () => {
      if (!connected) {
        roomId = roomIdInput.value;
        if (!/^\d{4}$/.test(roomId)) {
          notify("Invalid Room ID", 'error');
          return;
        }
        socket.emit('join', roomId);
      } else {
        socket.emit('leave');
        resetState();
      }
    };

    socket.on('joined', data => {
      connected = true;
      host = data.isHost;
      toggleRoomBtn.textContent = "Exit Room";
      statusRoom.textContent = roomId;
      notify("Joined Room " + roomId);
    });

    socket.on('deviceCount', count => {
      deviceCount.textContent = count;
    });

    socket.on('left', () => {
      resetState();
    });

    function resetState() {
      connected = false;
      toggleRoomBtn.textContent = "Join Room";
      statusRoom.textContent = "-";
      deviceCount.textContent = "0";
      downloadBtn.classList.add('hidden');
    }

    fileInput.onchange = () => {
      if (fileInput.files.length) {
        selectedFile = fileInput.files[0];
        fileInfo.textContent = `${selectedFile.name} - ${(selectedFile.size / 1024).toFixed(2)} KB`;
        fileInfo.classList.remove('hidden');
        sendBtn.classList.remove('hidden');
      }
    };

    sendBtn.onclick = () => {
      if (!selectedFile || !connected) return;
      const chunkSize = 64 * 1024;
      let offset = 0;
      progressCard.classList.remove('hidden');
      transferLabel.textContent = "Sending...";
      sendBtn.disabled = true;
      const reader = new FileReader();

      reader.onload = e => {
        const total = selectedFile.size;
        let sent = 0;
        socket.emit('send-meta', { name: selectedFile.name, size: total });

        function sendChunk() {
          const chunk = selectedFile.slice(offset, offset + chunkSize);
          reader.readAsArrayBuffer(chunk);
        }

        reader.onload = e => {
          const data = e.target.result;
          socket.emit('file-chunk', data);
          offset += chunkSize;
          sent += data.byteLength;
          updateProgress(sent, total);

          if (offset < total) {
            sendChunk();
          } else {
            socket.emit('file-complete');
            notify("File Sent");
            resetProgress();
          }
        };

        sendChunk();
      };

      reader.readAsArrayBuffer(selectedFile);
    };

    socket.on('file-meta', meta => {
      downloadBtn.classList.add('hidden');
      let chunks = [];
      let received = 0;
      const total = meta.size;
      transferLabel.textContent = "Receiving...";
      progressCard.classList.remove('hidden');

      socket.on('file-chunk', data => {
        chunks.push(new Uint8Array(data));
        received += data.byteLength;
        updateProgress(received, total);

        if (received >= total) {
          const blob = new Blob(chunks);
          const url = URL.createObjectURL(blob);
          downloadBtn.href = url;
          downloadBtn.download = meta.name;
          downloadBtn.classList.remove('hidden');
          notify("File Received");
          resetProgress();
        }
      });
    });

    cancelBtn.onclick = () => {
      socket.emit('cancel-transfer');
      resetProgress();
      notify("Transfer Cancelled", 'error');
    };

    function updateProgress(sent, total) {
      const percent = (sent / total) * 100;
      progressBar.value = percent;
      progressDetails.textContent = `${(sent / 1024).toFixed(2)} KB / ${(total / 1024).toFixed(2)} KB`;
    }

    function resetProgress() {
      progressCard.classList.add('hidden');
      progressBar.value = 0;
      progressDetails.textContent = "";
      sendBtn.disabled = false;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>LAN File Sharing</title>
 <style>
  * { box-sizing: border-box; }

  body {
   font-family: sans-serif;
   margin: 0;
   padding: 20px;
   background-color: #f4f4f4;
   position: relative;
  }

  h2, h3 { text-align: center; }

  .container {
   max-width: 500px;
   margin: auto;
   padding: 10px;
   background: white;
   border-radius: 10px;
   box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  input[type="text"], input[type="file"] {
   width: 100%;
   padding: 10px;
   margin: 10px 0;
   font-size: 16px;
   border: 1px solid #ccc;
   border-radius: 5px;
  }

  button {
   width: 100%;
   padding: 10px;
   font-size: 16px;
   margin-bottom: 20px;
   background-color: #4caf50;
   color: white;
   border: none;
   border-radius: 5px;
   cursor: pointer;
  }

  button:hover {
   background-color: #45a049;
  }

  .card {
   border: 1px solid #ccc;
   border-radius: 8px;
   padding: 15px;
   margin: 10px 0;
   background: #fff;
   box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .progress {
   width: 100%;
   height: 10px;
   background: #eee;
   border-radius: 5px;
   overflow: hidden;
   margin-top: 10px;
  }

  .bar {
   height: 100%;
   width: 0%;
   background: #4caf50;
   transition: width 0.3s;
  }

  a.download-link {
   display: block;
   margin-top: 10px;
   color: #007bff;
   word-break: break-word;
  }

  #roomDisplay, #connectedDisplay {
   text-align: center;
   font-weight: bold;
   margin: 10px 0;
  }

  .toast-container {
   position: fixed;
   bottom: 20px;
   right: 20px;
   z-index: 9999;
   display: flex;
   flex-direction: column;
   gap: 10px;
  }

  .toast {
   background-color: #333;
   color: #fff;
   padding: 10px 16px;
   border-radius: 8px;
   min-width: 200px;
   box-shadow: 0 2px 10px rgba(0,0,0,0.2);
   animation: fadeInOut forwards;
   min-width: 100px;
   display: flex;
   justify-content: space-around;
   align-items: center;
  }
  
  .toast .close-btn {
   position: relative;
   right: -10px;
   top: 8px;
   background: none;
   padding: 5px;
   font-size: 18px;
   font-weight:bold;
   color: #fff;
   border: 2px solid white;;
   cursor: pointer;
   text-align:center;
   max-width: 50px;
  }

  .toast.success { background-color: #4caf50; }
  .toast.error { background-color: #f44336; }
  .toast.info { background-color: #2196f3; }

  @keyframes fadeInOut {
   0% { opacity: 0; transform: translateY(20px); }
   100% { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 400px) {
   .container { padding: 10px; }
   h2, h3 { font-size: 18px; }
   button, input[type="text"], input[type="file"] { font-size: 14px; }
  }
 </style>
</head>
<body>

<div class="container">
 <h2>LAN File Sharing</h2>

 <input type="text" id="roomInput" placeholder="Enter Room Code (6-digit)" maxlength="6" />
 <button onclick="joinRoom()">Join Room</button>

 <div id="roomDisplay"></div>
 <div id="connectedDisplay"></div>

 <input type="file" id="fileInput" />
 <div id="fileCardContainer"></div>
 <button onclick="sendFile()">Send</button>

 <div id="receivedFiles">
  <h3>Received Files</h3>
 </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io();
let room = null;
let file = null;
let currentSend = { cancel: false, name: null };

const receivedBuffers = {};
const receivingCards = {};
const activeReceives = {};

function formatBytes(bytes) {
 const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
 if (bytes === 0) return '0 B';
 const i = Math.floor(Math.log(bytes) / Math.log(1024));
 return (bytes / Math.pow(1024, i)).toFixed(2).replace(/\.00$/, '') + ' ' + sizes[i];
}

function showToast(message, type = "info") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;

  const content = document.createElement("span");
  content.textContent = message;

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "✕";
  closeBtn.className = "close-btn";
  closeBtn.onclick = () => toast.remove();

  toast.appendChild(content);
  toast.appendChild(closeBtn);
  container.appendChild(toast);

  setTimeout(() => {
    if (toast.parentElement) toast.remove();
  }, 20000); // 20 seconds
}


function joinRoom() {
 const code = document.getElementById('roomInput').value.trim();
 if (code.length === 6) {
  room = code;
  document.getElementById('roomDisplay').innerText = 'Room Code: ' + room;
  socket.emit('join-room', room);
  showToast("Joined room : " + room, "success");
 } else {
  showToast("Please enter a valid 6-digit room ID.", "error");
 }
}

socket.on('update-count', (count) => {
 document.getElementById('connectedDisplay').innerText = `Connected: ${count}`;
});

document.getElementById('fileInput').addEventListener('change', e => {
 file = e.target.files[0];
 if (file) {
  document.getElementById("fileCardContainer").innerHTML = `
   <div class="card">
    <p><strong>${file.name}</strong></p>
    <p>${formatBytes(file.size)}</p>
    <div class="progress"><div id="progressBar" class="bar"></div></div>
   </div>
  `;
 }
});

function sendFile() {
 if (!file || !room) return;

 const chunkSize = 64 * 1024;
 let offset = 0;
 const reader = new FileReader();
 currentSend.cancel = false;
 currentSend.name = file.name;

 socket.emit("start-file", { room, name: file.name, size: file.size });

 const cancelBtn = document.createElement("button");
 cancelBtn.textContent = "Cancel";
 cancelBtn.style.backgroundColor = "red";
 cancelBtn.onclick = () => {
  currentSend.cancel = true;
  cancelBtn.disabled = true;
  socket.emit("cancel-file", { room, name: file.name });
 };

 const card = document.querySelector("#fileCardContainer .card");
 card.appendChild(cancelBtn);

 reader.onload = (e) => {
  if (currentSend.cancel) return;

  const done = offset + chunkSize >= file.size;
  socket.emit("file-chunk", {
   room, name: file.name, data: e.target.result, done
  });

  offset += chunkSize;
  document.getElementById("progressBar").style.width = `${(offset / file.size) * 100}%`;

  if (!done) {
   readSlice();
  } else {
   document.getElementById("progressBar").style.display = "none";
   cancelBtn.remove();
   document.getElementById("fileInput").value = ""; // Reset input
   file = null; // Clear selected file reference
   showToast("File Sent", "success");
  }
 };

 function readSlice() {
  if (currentSend.cancel) return;
  const slice = file.slice(offset, offset + chunkSize);
  reader.readAsArrayBuffer(slice);
 }

 readSlice();
}

socket.on("start-file", ({ name, size }) => {
 receivedBuffers[name] = { size, buffers: [], receivedSize: 0 };
 activeReceives[name] = true;

 const id = name.replace(/\W/g, '');
 const card = document.createElement("div");
 card.className = "card";
 card.innerHTML = `
  <p><strong>${name}</strong></p>
  <p>${formatBytes(size)}</p>
  <div class="progress"><div class="bar" id="recv-${id}"></div></div>
 `;
 const cancelBtn = document.createElement("button");
 cancelBtn.textContent = "Cancel";
 cancelBtn.style.backgroundColor = "red";
 cancelBtn.onclick = () => {
  activeReceives[name] = false;
  cancelBtn.disabled = true;
  card.innerHTML += `<p style="color:red">Transfer cancelled</p>`;
  socket.emit("cancel-file", { room, name });
 };
 card.appendChild(cancelBtn);

 document.getElementById("receivedFiles").appendChild(card);
 receivingCards[name] = `recv-${id}`;
});

socket.on("file-chunk", ({ name, data, done }) => {
 if (!receivedBuffers[name] || !activeReceives[name]) return;

 receivedBuffers[name].buffers.push(data);
 receivedBuffers[name].receivedSize += data.byteLength;

 const bar = document.getElementById(receivingCards[name]);
 const percentage = (receivedBuffers[name].receivedSize / receivedBuffers[name].size) * 100;
 bar.style.width = `${percentage}%`;

 if (done && activeReceives[name]) {
  const blob = new Blob(receivedBuffers[name].buffers);
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = name;
  link.className = "download-link";
  link.textContent = `⬇️ Download (${formatBytes(receivedBuffers[name].size)})`;

  const card = bar.closest(".card");
  bar.style.display = "none";

  card.appendChild(link);
  showToast("File Received", "info");

  cleanupReceive(name);
 }
});

socket.on("cancel-file", ({ name }) => {
 if (currentSend.name === name) {
  currentSend.cancel = true;
  document.getElementById("fileInput").value = ""; // Reset input
  file = null;
 }

 if (activeReceives[name]) {
  activeReceives[name] = false;
  const bar = document.getElementById(receivingCards[name]);
  if (bar) bar.style.display = "none";

  const card = bar.closest(".card");
  showToast("Transfer Cancelled by sender", "error");
 }

 cleanupReceive(name);
});

function cleanupReceive(name) {
 delete receivedBuffers[name];
 delete receivingCards[name];
 delete activeReceives[name];
}
</script>
</body>
</html>

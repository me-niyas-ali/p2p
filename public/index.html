<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>LAN File Sharing</title>
 <style>
  * {
   box-sizing: border-box;
  }

  body {
   font-family: sans-serif;
   margin: 0;
   padding: 20px;
   background-color: #f4f4f4;
  }

  h2, h3 {
   text-align: center;
  }

  .container {
   max-width: 500px;
   margin: auto;
   padding: 10px;
   background: white;
   border-radius: 10px;
   box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  input[type="text"], input[type="file"] {
   width: 100%;
   padding: 10px;
   margin: 10px 0;
   font-size: 16px;
   border: 1px solid #ccc;
   border-radius: 5px;
  }

  button {
   width: 100%;
   padding: 10px;
   font-size: 16px;
   margin-bottom: 20px;
   background-color: #4caf50;
   color: white;
   border: none;
   border-radius: 5px;
   cursor: pointer;
  }

  button:hover {
   background-color: #45a049;
  }

  .card {
   border: 1px solid #ccc;
   border-radius: 8px;
   padding: 15px;
   margin: 10px 0;
   background: #fff;
   box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .progress {
   width: 100%;
   height: 10px;
   background: #eee;
   border-radius: 5px;
   overflow: hidden;
   margin-top: 10px;
  }

  .bar {
   height: 100%;
   width: 0%;
   background: #4caf50;
   transition: width 0.3s;
  }

  a.download-link {
   display: block;
   margin-top: 10px;
   color: #007bff;
   word-break: break-all;
  }

  #roomDisplay, #connectedDisplay {
   text-align: center;
   font-weight: bold;
   margin: 10px 0;
  }

@media (max-width: 400px) {
   .container {
    padding: 10px;
   }

   h2, h3 {
    font-size: 18px;
   }

   button, input[type="text"], input[type="file"] {
    font-size: 14px;
   }
  }
 </style>
</head>
<body>

 <div class="container">
  <h2>LAN File Sharing</h2>

  <input type="text" id="roomInput" placeholder="Enter Room Code (6-digit)" maxlength="6" />
  <button onclick="joinRoom()">Join Room</button>

  <div id="roomDisplay"></div>
  <div id="connectedDisplay"></div>

  <input type="file" id="fileInput" />
  <div id="fileCardContainer"></div>
  <button onclick="sendFile()">Send</button>

  <div id="receivedFiles">
   <h3>Received Files</h3>
  </div>
 </div>

 <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
 <!-- Add inside <body> just before </body> -->
 <div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 999;"></div>

 <script>
  const socket = io(); // Connect to server
  let room = null;
  let file = null;
  let cancelTransfer = false;

  // Show simple toast messages
  function showToast(msg, type = "info") {
   const toast = document.createElement("div");
   toast.textContent = msg;
   toast.style = `
   background: ${type === "success" ? "#4caf50": type === "error" ? "#f44336": "#2196f3"};
   color: #fff;
   padding: 10px 20px;
   margin-top: 10px;
   border-radius: 5px;
   box-shadow: 0 2px 6px rgba(0,0,0,0.2);
   transition: opacity 0.5s ease;
   `;
   document.getElementById("toastContainer").appendChild(toast);
   setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 500);
   }, 4000);
  }

  // Format bytes to KB/MB
  function formatBytes(bytes) {
   const sizes = ['B',
    'KB',
    'MB'];
   const i = Math.floor(Math.log(bytes) / Math.log(1024));
   return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
  }

  // Join room with 6-digit code
  function joinRoom() {
   const code = document.getElementById('roomInput').value.trim();
   if (code.length === 6) {
    room = code;
    document.getElementById('roomDisplay').innerText = 'Room Code: ' + room;
    socket.emit('join-room', room);
    showToast("Joined room " + room, "success");
   } else {
    alert("Enter valid 6-digit room code.");
   }
  }

  // Update connected device count
  socket.on('update-count', count => {
   document.getElementById('connectedDisplay').innerText = `Connected: ${count}`;
  });

  // When file is selected
  document.getElementById('fileInput').addEventListener('change', e => {
   file = e.target.files[0];
  });

  // Send file in chunks
  function sendFile() {
   if (!file || !room) {
    alert("Select a file and join a room first.");
    return;
   }

   // Create file card when sending
   document.getElementById("fileCardContainer").innerHTML = `
   <div class="card">
   <p><strong>${file.name}</strong></p>
   <p id="sendSize">0 / ${formatBytes(file.size)}</p>
   <div class="progress"><div id="progressBar" class="bar"></div></div>
   <button onclick="cancelTransfer = true">Cancel</button>
   </div>
   `;

   const chunkSize = 64 * 1024; // 64 KB
   let offset = 0;
   const reader = new FileReader();
   cancelTransfer = false;

   socket.emit("start-file", {
    room, name: file.name, size: file.size
   });

   reader.onload = e => {
    if (cancelTransfer) {
     showToast("Transfer cancelled", "error");

     document.getElementById("progressBar").style.display = "none";
     const cancelBtn = document.querySelector("#fileCardContainer .card button");
     if (cancelBtn) cancelBtn.style.display = "none";

     return;
    }

    const done = offset + chunkSize >= file.size;

    socket.emit("file-chunk", {
     room,
     name: file.name,
     data: e.target.result,
     done
    });

    offset += chunkSize;
    document.getElementById("progressBar").style.width = `${(offset / file.size) * 100}%`;
    document.getElementById("sendSize").innerText = `${formatBytes(offset)} / ${formatBytes(file.size)}`;

    if (!done) {
     readNext();
    } else {
     // Hide progress bar and cancel button
     document.getElementById("progressBar").style.display = "none";
     document.querySelector("#fileCardContainer .card button").style.display = "none";
     document.querySelector(".progress").style.display = "none";

     // Show success message
     const msg = document.createElement("p");
     msg.textContent = "File Sent";
     msg.style.color = "green";
     document.querySelector("#fileCardContainer .card").appendChild(msg);

     showToast("File sent", "success");
    }

   };

   function readNext() {
    const slice = file.slice(offset, offset + chunkSize);
    reader.readAsArrayBuffer(slice);
   }

   readNext();
  }

  // Prepare to receive file
  const received = {}; // Store ongoing file chunks

  socket.on("start-file", ({
   name, size
  }) => {
   received[name] = {
    size, buffers: [], receivedSize: 0
   };

   const id = name.replace(/\W/g, '');
   const card = document.createElement("div");
   card.className = "card";
   card.innerHTML = `
   <p><strong>${name}</strong></p>
   <p>${formatBytes(size)}</p>
   <p id="recvSize-${id}">0 / ${formatBytes(size)}</p>
   <div class="progress"><div class="bar" id="recvBar-${id}"></div></div>
   <button onclick="received['${name}'].cancel = true">Cancel</button>
   `;
   document.getElementById("receivedFiles").appendChild(card);
  });

  // Receive file chunks
  socket.on("file-chunk", ({
   name, data, done
  }) => {
   if (!received[name] || received[name].cancel) {
    showToast("Receiver cancelled", "error");
    delete received[name];
    return;
   }

   received[name].buffers.push(data);
   received[name].receivedSize += data.byteLength;

   const id = name.replace(/\W/g, '');
   const bar = document.getElementById(`recvBar-${id}`);
   bar.style.width = `${(received[name].receivedSize / received[name].size) * 100}%`;

   document.getElementById(`recvSize-${id}`).innerText =
   `${formatBytes(received[name].receivedSize)} / ${formatBytes(received[name].size)}`;

   // File complete
   if (done) {
    // Hide progress bar
    bar.style.display = "none";

    // Hide cancel button if present (optional, if you add one on receiver side)
    const cancelBtn = card.querySelector("button");
    if (cancelBtn) cancelBtn.style.display = "none";

    // Show download + message
    const msg = document.createElement("p");
    msg.textContent = "File Received";
    msg.style.color = "blue";
    card.appendChild(msg);
    card.appendChild(link);

    showToast("File received", "info");

    delete receivedBuffers[name];
    delete receivingCards[name];
   }
  });
 </script>


</body>
</html>